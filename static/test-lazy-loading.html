<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Lazy Loading & Performance</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/shared/css/base.css">
    <link rel="stylesheet" href="/static/shared/css/dashboard-components.css">
    
    <style>
        .metric-card {
            @apply bg-white p-4 rounded-lg shadow-sm border border-gray-200;
        }
        .metric-value {
            @apply text-2xl font-bold text-blue-600;
        }
        .metric-label {
            @apply text-sm text-gray-600;
        }
        .test-section {
            @apply mb-8 p-6 bg-white rounded-lg shadow-sm border border-gray-200;
        }
        .status-indicator {
            @apply inline-block w-3 h-3 rounded-full mr-2;
        }
        .status-success { @apply bg-green-500; }
        .status-error { @apply bg-red-500; }
        .status-warning { @apply bg-yellow-500; }
        .status-info { @apply bg-blue-500; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Test Lazy Loading & Performance</h1>
            <p class="text-gray-600">Pengujian sistem lazy loading, performance monitoring, dan unit testing</p>
        </div>

        <!-- Performance Metrics -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">📊 Performance Metrics</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="metric-card">
                    <div class="metric-value" id="pageLoadTime">-</div>
                    <div class="metric-label">Page Load Time (ms)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="modulesLoaded">0</div>
                    <div class="metric-label">Modules Loaded</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memoryUsage">-</div>
                    <div class="metric-label">Memory Usage (%)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="networkRequests">0</div>
                    <div class="metric-label">Network Requests</div>
                </div>
            </div>
            <div class="space-x-2">
                <button id="startMonitoring" class="btn btn-primary">Start Monitoring</button>
                <button id="stopMonitoring" class="btn btn-secondary">Stop Monitoring</button>
                <button id="generateReport" class="btn btn-info">Generate Report</button>
                <button id="exportMetrics" class="btn btn-success">Export Metrics</button>
            </div>
        </div>

        <!-- Module Loading Tests -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🚀 Module Loading Tests</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <button class="btn btn-primary module-btn" data-module="shared">Load Shared Utilities</button>
                <button class="btn btn-primary module-btn" data-module="charts">Load Chart Components</button>
                <button class="btn btn-primary module-btn" data-module="analytics">Load Analytics Module</button>
                <button class="btn btn-primary module-btn" data-module="android">Load Android Module</button>
                <button class="btn btn-primary module-btn" data-module="discord">Load Discord Module</button>
                <button class="btn btn-primary module-btn" data-module="products">Load Products Module</button>
            </div>
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Loaded Modules:</h3>
                <div id="loadedModulesList" class="text-sm text-gray-600">Belum ada modul yang dimuat</div>
            </div>
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Loading Log:</h3>
                <div id="loadingLog" class="bg-gray-100 p-3 rounded text-sm font-mono h-32 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Unit Testing -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🧪 Unit Testing</h2>
            <div class="mb-4 space-x-2">
                <button id="runAllTests" class="btn btn-primary">Run All Tests</button>
                <button id="runSharedTests" class="btn btn-secondary">Test Shared Utils</button>
                <button id="runIntegrationTests" class="btn btn-info">Test Integration</button>
                <button id="exportTestResults" class="btn btn-success">Export Results</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="metric-card">
                    <div class="metric-value text-green-600" id="testsPassed">0</div>
                    <div class="metric-label">Tests Passed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-red-600" id="testsFailed">0</div>
                    <div class="metric-label">Tests Failed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="testsTotal">0</div>
                    <div class="metric-label">Total Tests</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="testDuration">0</div>
                    <div class="metric-label">Duration (ms)</div>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Test Results:</h3>
                <div id="testResults" class="bg-gray-100 p-3 rounded text-sm h-40 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Sample Dashboard -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">📈 Sample Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stats-card">
                    <div class="stats-card-header">
                        <h3 class="stats-card-title">Revenue</h3>
                    </div>
                    <div id="sampleRevenue" class="stats-card-value">Rp 0</div>
                    <div id="sampleRevenueChange" class="stats-card-change"></div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-header">
                        <h3 class="stats-card-title">Orders</h3>
                    </div>
                    <div id="sampleOrders" class="stats-card-value">0</div>
                    <div id="sampleOrdersChange" class="stats-card-change"></div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-header">
                        <h3 class="stats-card-title">Conversion Rate</h3>
                    </div>
                    <div id="sampleRate" class="stats-card-value">0%</div>
                    <div id="sampleRateChange" class="stats-card-change"></div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-header">
                        <h3 class="stats-card-title">Avg Order Value</h3>
                    </div>
                    <div id="sampleValue" class="stats-card-value">Rp 0</div>
                    <div id="sampleValueChange" class="stats-card-change"></div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold mb-4">Sample Chart</h3>
                <div class="h-64">
                    <canvas id="sampleChart"></canvas>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🔧 System Status</h2>
            <div id="systemStatus" class="space-y-2">
                <div class="flex items-center">
                    <span class="status-indicator status-info"></span>
                    <span>Initializing system...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Scripts (loaded first) -->
    <script src="/static/shared/js/module-loader.js"></script>
    <script src="/static/shared/js/performance-monitor.js"></script>
    <script src="/static/shared/js/test-framework.js"></script>

    <!-- Main Application Script -->
    <script>
        class TestApplication {
            constructor() {
                this.isInitialized = false;
                this.loadedModules = new Set();
                this.init();
            }

            async init() {
                console.log('🚀 Initializing Test Application...');
                this.updateSystemStatus('Initializing application...', 'info');
                
                // Start performance monitoring
                performanceMonitor.startMonitoring();
                this.updateSystemStatus('Performance monitoring started', 'success');
                
                // Setup event listeners
                this.setupEventListeners();
                this.updateSystemStatus('Event listeners setup complete', 'success');
                
                // Update initial metrics
                this.updateMetrics();
                this.updateSystemStatus('Initial metrics loaded', 'success');
                
                // Load test definitions
                await this.loadTestDefinitions();
                this.updateSystemStatus('Test definitions loaded', 'success');
                
                this.isInitialized = true;
                this.updateSystemStatus('Application ready!', 'success');
                
                console.log('✅ Test Application initialized successfully');
            }

            setupEventListeners() {
                // Performance monitoring buttons
                document.getElementById('startMonitoring').addEventListener('click', () => {
                    performanceMonitor.startMonitoring();
                    this.addToLog('Performance monitoring started');
                });

                document.getElementById('stopMonitoring').addEventListener('click', () => {
                    performanceMonitor.stopMonitoring();
                    this.addToLog('Performance monitoring stopped');
                });

                document.getElementById('generateReport').addEventListener('click', () => {
                    const report = performanceMonitor.generateReport();
                    console.log('Performance Report:', report);
                    this.addToLog('Performance report generated (check console)');
                });

                document.getElementById('exportMetrics').addEventListener('click', () => {
                    performanceMonitor.exportMetrics();
                    this.addToLog('Performance metrics exported');
                });

                // Module loading buttons
                document.querySelectorAll('.module-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const moduleGroup = e.target.dataset.module;
                        await this.loadModuleGroup(moduleGroup);
                    });
                });

                // Testing buttons
                document.getElementById('runAllTests').addEventListener('click', () => {
                    this.runAllTests();
                });

                document.getElementById('runSharedTests').addEventListener('click', () => {
                    this.runSharedTests();
                });

                document.getElementById('runIntegrationTests').addEventListener('click', () => {
                    this.runIntegrationTests();
                });

                document.getElementById('exportTestResults').addEventListener('click', () => {
                    testFramework.exportResults();
                    this.addToLog('Test results exported');
                });

                // Update metrics every 5 seconds
                setInterval(() => {
                    this.updateMetrics();
                }, 5000);
            }

            async loadModuleGroup(groupName) {
                try {
                    this.addToLog(`Loading module group: ${groupName}...`);
                    const startTime = performance.now();
                    
                    await moduleLoader.loadModuleGroup(groupName);
                    
                    const endTime = performance.now();
                    const duration = (endTime - startTime).toFixed(2);
                    
                    this.addToLog(`✅ Module group '${groupName}' loaded in ${duration}ms`);
                    this.updateLoadedModules();
                    this.updateMetrics();
                    
                    // Update sample dashboard if analytics is loaded
                    if (groupName === 'analytics' || groupName === 'shared') {
                        this.updateSampleDashboard();
                    }
                    
                } catch (error) {
                    this.addToLog(`❌ Failed to load module group '${groupName}': ${error.message}`);
                    console.error('Module loading error:', error);
                }
            }

            async loadTestDefinitions() {
                try {
                    // Pastikan test framework sudah siap
                    if (typeof testFramework === 'undefined') {
                        throw new Error('Test framework not loaded');
                    }
                    
                    // Load test file
                    const script = document.createElement('script');
                    script.src = '/static/tests/module-tests.js';
                    
                    return new Promise((resolve, reject) => {
                        script.onload = () => {
                            this.addToLog('Test definitions loaded successfully');
                            resolve();
                        };
                        script.onerror = () => {
                            this.addToLog('Failed to load test definitions');
                            reject(new Error('Failed to load test definitions'));
                        };
                        document.head.appendChild(script);
                    });
                } catch (error) {
                    console.error('Error loading test definitions:', error);
                    this.addToLog(`Error loading test definitions: ${error.message}`);
                }
            }

            async runAllTests() {
                try {
                    this.addToTestResults('🚀 Running all tests...');
                    
                    // Ensure required modules are loaded
                    await this.ensureModulesLoaded(['shared', 'charts', 'analytics']);
                    
                    const results = await testFramework.runAllTests();
                    this.updateTestMetrics(results);
                    this.addToTestResults('✅ All tests completed');
                    
                } catch (error) {
                    this.addToTestResults(`❌ Test execution failed: ${error.message}`);
                    console.error('Test execution error:', error);
                }
            }

            async runSharedTests() {
                try {
                    this.addToTestResults('🧪 Running shared utilities tests...');
                    await this.ensureModulesLoaded(['shared']);
                    
                    // Run only shared utility tests
                    const results = await testFramework.runAllTests();
                    this.updateTestMetrics(results);
                    
                } catch (error) {
                    this.addToTestResults(`❌ Shared tests failed: ${error.message}`);
                }
            }

            async runIntegrationTests() {
                try {
                    this.addToTestResults('🔗 Running integration tests...');
                    await this.ensureModulesLoaded(['shared', 'charts', 'analytics']);
                    
                    const results = await testFramework.runAllTests();
                    this.updateTestMetrics(results);
                    
                } catch (error) {
                    this.addToTestResults(`❌ Integration tests failed: ${error.message}`);
                }
            }

            async ensureModulesLoaded(moduleGroups) {
                for (const group of moduleGroups) {
                    if (!this.loadedModules.has(group)) {
                        await this.loadModuleGroup(group);
                        this.loadedModules.add(group);
                    }
                }
            }

            updateMetrics() {
                // Performance metrics
                const performanceMetrics = performanceMonitor.getMetrics();
                const moduleMetrics = moduleLoader.getPerformanceMetrics();
                
                document.getElementById('pageLoadTime').textContent = 
                    performanceMetrics.pageLoadTime ? performanceMetrics.pageLoadTime.toFixed(2) : '-';
                
                document.getElementById('modulesLoaded').textContent = moduleMetrics.modulesLoaded;
                
                document.getElementById('networkRequests').textContent = performanceMetrics.networkRequests.length;
                
                // Memory usage
                if (performanceMetrics.memoryAnalysis && performanceMetrics.memoryAnalysis.current) {
                    document.getElementById('memoryUsage').textContent = 
                        performanceMetrics.memoryAnalysis.current.percentage + '%';
                } else {
                    document.getElementById('memoryUsage').textContent = '-';
                }
            }

            updateLoadedModules() {
                const loadedModules = moduleLoader.getLoadedModules();
                const modulesList = document.getElementById('loadedModulesList');
                
                if (loadedModules.length === 0) {
                    modulesList.textContent = 'Belum ada modul yang dimuat';
                } else {
                    modulesList.innerHTML = loadedModules.map(module => 
                        `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-1 mb-1">${module}</span>`
                    ).join('');
                }
            }

            updateTestMetrics(results) {
                document.getElementById('testsPassed').textContent = results.stats.passed;
                document.getElementById('testsFailed').textContent = results.stats.failed;
                document.getElementById('testsTotal').textContent = results.stats.total;
                document.getElementById('testDuration').textContent = results.stats.duration.toFixed(2);
            }

            updateSampleDashboard() {
                try {
                    if (typeof MockDataGenerator !== 'undefined' && typeof Formatters !== 'undefined') {
                        const mockStats = MockDataGenerator.generateOverviewStats();
                        
                        document.getElementById('sampleRevenue').textContent = 
                            Formatters.formatCurrency(mockStats.total_revenue);
                        document.getElementById('sampleOrders').textContent = 
                            Formatters.formatNumber(mockStats.total_orders);
                        document.getElementById('sampleRate').textContent = 
                            `${mockStats.conversion_rate.toFixed(1)}%`;
                        document.getElementById('sampleValue').textContent = 
                            Formatters.formatCurrency(mockStats.avg_order_value);
                        
                        // Update change indicators if UIUtils is available
                        if (typeof UIUtils !== 'undefined') {
                            UIUtils.updateChangeIndicator(
                                document.getElementById('sampleRevenueChange'), 
                                mockStats.revenue_change
                            );
                            UIUtils.updateChangeIndicator(
                                document.getElementById('sampleOrdersChange'), 
                                mockStats.orders_change
                            );
                            UIUtils.updateChangeIndicator(
                                document.getElementById('sampleRateChange'), 
                                mockStats.conversion_change
                            );
                            UIUtils.updateChangeIndicator(
                                document.getElementById('sampleValueChange'), 
                                mockStats.aov_change
                            );
                        }
                        
                        // Create sample chart if chart manager is available
                        if (typeof chartManager !== 'undefined') {
                            const chartData = MockDataGenerator.generateRevenueData(7);
                            const config = {
                                type: 'line',
                                data: {
                                    labels: chartData.map(item => Formatters.formatChartDate(item.date)),
                                    datasets: [{
                                        label: 'Revenue',
                                        data: chartData.map(item => item.revenue),
                                        borderColor: 'rgb(59, 130, 246)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            };
                            
                            chartManager.createChart('sampleChart', config);
                        }
                    }
                } catch (error) {
                    console.error('Error updating sample dashboard:', error);
                }
            }

            addToLog(message) {
                const log = document.getElementById('loadingLog');
                const timestamp = new Date().toLocaleTimeString();
                log.innerHTML += `[${timestamp}] ${message}
`;
                log.scrollTop = log.scrollHeight;
            }

            addToTestResults(message) {
                const results = document.getElementById('testResults');
                const timestamp = new Date().toLocaleTimeString();
                results.innerHTML += `[${timestamp}] ${message}
`;
                results.scrollTop = results.scrollHeight;
            }

            updateSystemStatus(message, type = 'info') {
                const statusContainer = document.getElementById('systemStatus');
                const statusDiv = document.createElement('div');
                statusDiv.className = 'flex items-center';
                statusDiv.innerHTML = `
                    <span class="status-indicator status-${type}"></span>
                    <span>${message}</span>
                `;
                statusContainer.appendChild(statusDiv);
            }
        }

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.testApp = new TestApplication();
        });
    </script>
</body>
</html>
